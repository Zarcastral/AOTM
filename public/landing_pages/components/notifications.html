<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification in Iframe</title>
    <link rel="stylesheet" href="../../../src/style/components/notifications.css">
</head>

<body>
    <div class="notification-container">
        <div class="back-arrow">‚Üê</div>
        <div class="notification-header">Notifications</div>
        <div id="notification-list">
            <!-- Notifications will be dynamically inserted here -->
        </div>
    </div>

    <script type="module">
        import {
            collection,
            getDocs,
            getFirestore,
            query,
            where,
            doc,
            updateDoc,
        } from "firebase/firestore";
        import app from "../../../src/config/firebase_config.js";

        const db = getFirestore(app);
        const notificationList = document.getElementById('notification-list');

        async function fetchNotifications() {
            try {
                const farmerId = sessionStorage.getItem("farmer_id");

                if (!farmerId) {
                    console.error("No farmer_id found in sessionStorage");
                    notificationList.innerHTML = '<div>No farmer ID found. Please log in.</div>';
                    return;
                }

                const q = query(
                    collection(db, "tb_notifications"),
                    where("farmer_id", "==", farmerId)
                );

                const querySnapshot = await getDocs(q);
                notificationList.innerHTML = '';

                if (querySnapshot.empty) {
                    notificationList.innerHTML = '<div>No notifications found for this farmer.</div>';
                    return;
                }

                querySnapshot.forEach((docSnapshot) => {
                    const data = docSnapshot.data();
                    const docId = docSnapshot.id; // Get the document ID

                    const notificationItem = document.createElement('div');
                    notificationItem.className = 'notification-item';

                    const title = document.createElement('div');
                    title.className = `title ${data.read ? '' : 'unread'}`;
                    title.textContent = data.title;

                    const description = document.createElement('div');
                    description.className = 'description';
                    description.textContent = data.description;

                    notificationItem.appendChild(title);
                    notificationItem.appendChild(description);
                    notificationList.appendChild(notificationItem);

                    // Add click event to mark as read
                    notificationItem.addEventListener('click', async () => {
                        if (!data.read) { // Only update if not already read
                            try {
                                // Update Firestore document
                                const notificationRef = doc(db, "tb_notifications", docId);
                                await updateDoc(notificationRef, { read: true });

                                // Update UI: Remove unread class
                                title.classList.remove('unread');
                            } catch (error) {
                                console.error("Error marking notification as read: ", error);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error("Error fetching notifications: ", error);
                notificationList.innerHTML = '<div>Error loading notifications.</div>';
            }
        }

        fetchNotifications();
    </script>
</body>

</html>