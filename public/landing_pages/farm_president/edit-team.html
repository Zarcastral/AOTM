<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Team</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .header h1 {
            color: #2e7d32;
            margin: 0;
            font-size: 24px;
        }
        .add-farmer {
            color: #2e7d32;
            text-decoration: none;
            font-weight: bold;
        }
        .search-bar {
            margin-bottom: 20px;
        }
        .search-bar input {
            width: 200px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f5f5f5;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 14px;
        }
        td {
            font-size: 14px;
        }
        .action-btn {
            background-color: #d32f2f;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pagination {
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .pagination span {
            margin: 0 10px;
            font-size: 14px;
        }
        .pagination button {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
        }
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            width: 400px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .search-results {
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background: #fff;
            width: 100%;
            z-index: 10;
        }
        .search-item {
            padding: 8px;
            cursor: pointer;
        }
        .search-item:hover {
            background: #f0f0f0;
        }
        .farmer-box {
            border: 1px solid #ccc;
            padding: 10px;
            min-height: 50px;
        }
        .farmer-item {
            background: #f0f0f0;
            padding: 5px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }
        .remove-btn {
            color: red;
            cursor: pointer;
            border: none;
            background: none;
        }
        .save-btn {
            background-color: #2e7d32;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="teamNameHeader">Team Name</h1>
            <a href="#" class="add-farmer" id="addFarmerBtn">+ Add Farmer</a>
        </div>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search">
        </div>
        <table id="teamTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Farmer's Name</th>
                    <th>User Role</th>
                    <th>Contact</th>
                    <th>Barangay</th>
                    <th>Farmer's Name</th>
                </tr>
            </thead>
            <tbody id="teamTableBody"></tbody>
        </table>
        <div class="pagination">
            <button id="prevPage">&lt;</button>
            <span id="pageInfo">1 of 1</span>
            <button id="nextPage">&gt;</button>
        </div>
    </div>

    <div class="popup" id="addFarmerPopup">
        <div class="popup-content">
            <span class="close-btn" id="closePopup">&times;</span>
            <h2>Add Farmer</h2>
            <div class="form-group">
                <label for="farmerSearch">Search Farmer:</label>
                <input type="text" id="farmerSearch" placeholder="Search for a farmer">
                <div id="searchResults" class="search-results"></div>
            </div>
            <div class="form-group">
                <label>Selected Farmers:</label>
                <div id="farmerBox" class="farmer-box"></div>
            </div>
            <button class="save-btn" id="saveFarmerBtn">Save</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc,
            collection,
            getDocs,
            query,
            where
        } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: import.meta.env.VITE_FIREBASE_API_KEY,
            authDomain: import.meta.env.VITE_FIREBASE_AUTH_DOMAIN,
            projectId: import.meta.env.VITE_FIREBASE_PROJECT_ID,
            storageBucket: import.meta.env.VITE_FIREBASE_STORAGE_BUCKET,
            messagingSenderId: import.meta.env.VITE_FIREBASE_MESSAGING_SENDER_ID,
            appId: import.meta.env.VITE_FIREBASE_APP_ID,
            measurementId: import.meta.env.VITE_FIREBASE_MEASUREMENT_ID,
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const urlParams = new URLSearchParams(window.location.search);
        const teamId = urlParams.get('teamId');
        let teamData = null;
        let farmersList = [];
        let currentFarmers = [];
        let currentPage = 1;
        const itemsPerPage = 5;

        async function loadTeamData() {
            if (!teamId) {
                alert('No team ID provided');
                window.location.href = 'team-list.html';
                return;
            }

            try {
                const teamRef = doc(db, "tb_teams", teamId);
                const teamSnap = await getDoc(teamRef);

                if (teamSnap.exists()) {
                    teamData = teamSnap.data();
                    document.getElementById('teamNameHeader').textContent = teamData.team_name || 'Team Name';
                    currentFarmers = teamData.farmer_name || [];
                    await fetchFarmers();
                    renderTable();
                } else {
                    alert('Team not found');
                    window.location.href = 'team-list.html';
                }
            } catch (error) {
                console.error('Error loading team data:', error);
                alert('Error loading team data');
            }
        }

        async function fetchFarmers() {
            try {
                const currentBarangay = teamData.barangay_name;
                const teamsSnapshot = await getDocs(collection(db, "tb_teams"));
                const excludedFarmerIds = new Set();

                teamsSnapshot.forEach((teamDoc) => {
                    const teamData = teamDoc.data();
                    if (teamData.farmer_name && Array.isArray(teamData.farmer_name)) {
                        teamData.farmer_name.forEach(farmerObj => {
                            if (farmerObj.farmer_id) {
                                excludedFarmerIds.add(String(farmerObj.farmer_id));
                            }
                        });
                    }
                });

                const q = query(
                    collection(db, "tb_farmers"),
                    where("user_type", "==", "Farmer"),
                    where("barangay_name", "==", currentBarangay)
                );

                const querySnapshot = await getDocs(q);
                farmersList = querySnapshot.docs
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }))
                    .filter(farmer => !excludedFarmerIds.has(String(farmer.farmer_id)));
            } catch (error) {
                console.error("Error fetching farmers:", error);
            }
        }

        function renderTable(searchTerm = '') {
            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';

            const filteredFarmers = currentFarmers.filter(farmer => 
                farmer.farmer_name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedFarmers = filteredFarmers.slice(start, end);

            paginatedFarmers.forEach((farmer, index) => {
                const row = document.createElement('tr');
                const userRole = farmer.farmer_name === teamData.lead_farmer ? 'Head Farmer' : 'Farmer';
                const contact = '0987654321'; // Placeholder, replace with actual data if available
                row.innerHTML = `
                    <td>${start + index + 1}</td>
                    <td>${farmer.farmer_name}</td>
                    <td>${userRole}</td>
                    <td>${contact}</td>
                    <td>${teamData.barangay_name}</td>
                    <td>
                        <button class="action-btn" data-farmer-id="${farmer.farmer_id}">Remove</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination(filteredFarmers.length);
            addRemoveEventListeners();
        }

        function updatePagination(totalItems) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            currentPage = Math.min(currentPage, totalPages || 1);
            document.getElementById('pageInfo').textContent = `${currentPage} of ${totalPages || 1}`;
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage === totalPages;
        }

        function addRemoveEventListeners() {
            document.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const farmerId = e.target.dataset.farmerId;
                    currentFarmers = currentFarmers.filter(farmer => farmer.farmer_id !== farmerId);
                    await updateTeamInFirestore();
                    renderTable(document.getElementById('searchInput').value);
                });
            });
        }

        async function updateTeamInFirestore() {
            try {
                const teamRef = doc(db, "tb_teams", teamId);
                await updateDoc(teamRef, { farmer_name: currentFarmers });
            } catch (error) {
                console.error('Error updating team:', error);
                alert('Error updating team');
            }
        }

        function renderFarmerResults(searchValue = '') {
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '';

            const filteredFarmers = farmersList.filter(farmer =>
                (`${farmer.last_name}, ${farmer.first_name} ${farmer.middle_name || ''}`).toLowerCase().includes(searchValue.toLowerCase())
            );

            if (filteredFarmers.length === 0) {
                resultsContainer.innerHTML = '<div class="search-item">No matching farmers found</div>';
                return;
            }

            filteredFarmers.forEach(farmer => {
                const div = document.createElement('div');
                div.classList.add('search-item');
                div.textContent = `${farmer.last_name}, ${farmer.first_name} ${farmer.middle_name || ''}`;
                div.dataset.id = farmer.id;
                div.addEventListener('click', () => {
                    addFarmerToBox(farmer);
                    resultsContainer.innerHTML = '';
                });
                resultsContainer.appendChild(div);
            });
        }

        function addFarmerToBox(farmer) {
            const farmerBox = document.getElementById('farmerBox');
            const farmerDiv = document.createElement('div');
            farmerDiv.classList.add('farmer-item');
            farmerDiv.textContent = `${farmer.last_name}, ${farmer.first_name} ${farmer.middle_name || ''}`;

            const removeBtn = document.createElement('button');
            removeBtn.textContent = 'X';
            removeBtn.classList.add('remove-btn');
            removeBtn.addEventListener('click', () => {
                farmerDiv.remove();
                farmersList.push(farmer);
            });

            farmerDiv.appendChild(removeBtn);
            farmerBox.appendChild(farmerDiv);
            farmersList = farmersList.filter(f => f.id !== farmer.id);
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderTable(e.target.value);
        });

        document.getElementById('prevPage').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable(document.getElementById('searchInput').value);
            }
        });

        document.getElementById('nextPage').addEventListener('click', () => {
            const totalPages = Math.ceil(currentFarmers.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable(document.getElementById('searchInput').value);
            }
        });

        document.getElementById('addFarmerBtn').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('addFarmerPopup').style.display = 'flex';
        });

        document.getElementById('closePopup').addEventListener('click', () => {
            document.getElementById('addFarmerPopup').style.display = 'none';
            document.getElementById('farmerBox').innerHTML = '';
            document.getElementById('farmerSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
        });

        document.getElementById('farmerSearch').addEventListener('input', (e) => {
            renderFarmerResults(e.target.value);
        });

        document.getElementById('saveFarmerBtn').addEventListener('click', async () => {
            const farmerBox = document.getElementById('farmerBox');
            const newFarmers = Array.from(farmerBox.getElementsByClassName('farmer-item'))
                .map(item => {
                    const farmerName = item.firstChild.textContent.trim();
                    const farmer = farmersList.find(f => 
                        `${f.last_name}, ${f.first_name} ${f.middle_name || ''}` === farmerName
                    ) || teamData.farmer_name.find(f => f.farmer_name === farmerName);
                    return {
                        farmer_id: farmer?.farmer_id || '',
                        farmer_name: farmerName
                    };
                });

            currentFarmers = [...currentFarmers, ...newFarmers];
            await updateTeamInFirestore();
            renderTable();
            document.getElementById('addFarmerPopup').style.display = 'none';
            document.getElementById('farmerBox').innerHTML = '';
            document.getElementById('farmerSearch').value = '';
            document.getElementById('searchResults').innerHTML = '';
            await fetchFarmers();
        });

        document.addEventListener('DOMContentLoaded', loadTeamData);
    </script>
</body>
</html>